# 独自拡張要素

このモジュールにおいて、一般的なBrainfuckの仕様から独自に拡張された要素について解説します。

## 概念

### レジスタ

レジスタは、一般的なBrainfuckで`+`や`-`の対象となるような、ある一つの数値をもつ変数を表す構造です。インタプリタは現在選択されているレジスタに対して`+`などのコマンドを実行します。

レジスタの値を変更するコマンドは、以下の通りです：

- `+`
- `-`
- `=`

また、以下のコマンドは現在選択されているレジスタの値を参照します：

- `[`
- `]`
- `?`

### フィールド

フィールドは、一般的なBrainfuckで用いられる配列のような、値を保持する変数の配列とその配列の中での現在地を持つ構造を言います。

フィールドは

- レジスタの配列
- 現在地を表すレジスタ（ポインタレジスタ）

を持ちます。

このモジュールでは

- 配列フィールド
- 文字フィールド
- リターンフィールド

の三つが存在し、それぞれに役割が与えられています。

### カウンタ

カウンタは、`+`や`=`など回数や値などを指定できるコマンドで使用されます。

カウンタの値は`[0-9]`コマンドによってセットしたり、`?`コマンドによってレジスタの値をコピーしたりして設定します。カウンタは`+`や`=`などカウンタを用いるコマンドを実行したときにリセットされます。

セットされていない状態では`1`をセットしたときと同じです。

カウンタは、以下のコマンドで設定します：

- `[0-9]`
- `?`

また、以下のコマンドで消費します：

- `+`
- `-`
- `=`
- `[`
- `]`
- `>`
- `<`

## コマンド

このモジュールでは、以下のコマンドを追加しています。

- `[0-9]`
- `[a-zA-Z]`
- `=`
- `?`
- `|`
- `_`
- `#`
- `*`
- `@`
- `$`
- `&`

### [0-9]

カウンタがセットされていないとき、カウンタを指定した値にセットします。

カウンタがセットされているとき、*count*を10倍して、指定した値を加えます。

```txt
+-- カウンタがセットされていないので、3にセット
|
|   +-- カウンタの値(38)を選択中のレジスタに加える。
v   v
3 8 +
  ^
  +-- カウンタの値(3)を10倍して、8を加える。結果カウンタは38になる
```

### [a-zA-Z]

文字フィールドの指定した文字に対応するレジスタを選択します。

```txt
A++++ b+++ A+++++
Aは9、bは3
```

### =

現在のレジスタの値を*count*に置き換えます。

```txt
25A=
Aは25
```

### ?

カウンタを現在のレジスタの値に*count*を乗じた値にセットします。

```txt
25A= A?B=
Bは25 * 1
```

```txt
25A= 4A?B=
Bは25 * 4
```

### |

*1レジスタ*を選択します。

*1レジスタ*は値が常に1であることが保証されているレジスタで、`+`、`=`などの影響を受けません。

### _

*0レジスタ*を選択します。

*0レジスタ*は値が常に0であることが保証されているレジスタで、`+`、`=`などの影響を受けません。

### #

*配列フィールド*を選択します。

*配列フィールド*は自由に使用できる配列で、本来のBrainfuckにおける配列の役割を担います。

### *

*配列フィールドポインタ*を選択します。

### @

*リターンフィールド*を選択します。

*リターンフィールド*は`[`が実行される度に実行位置を保存し、`]`で実行位置を移動させるために使用されます。

### $

*リターンフィールドポインタ*を選択します。

*リターンフィールドポインタ*は`[`、`]`の実行時に変更されることがあります。

### &

*カーソルレジスタ*を選択します。

*カーソルレジスタ*は現在の実行位置そのものです。このレジスタの値を変更した場合、実行位置はそれに伴って移動します。（ただし、コマンドの実行時に1加算されるため実際には設定した一つ後ろのコマンドが次に実行されます。）

### +

現在のレジスタの値に*count*を加えます。

### -

現在のレジスタの値から*count*を引きます。

### >

配列フィールドポインタの値に*count*を加えます。

これは`*+`とほぼ同じ効果をもたらしますが、選択中のレジスタを変更しません。

### <

配列フィールドポインタの値から*count*を引きます。

これは`*-`とほぼ同じ効果をもたらしますが、選択中のレジスタを変更しません。

### ,

入力ストリームから1つ読み込み、現在のレジスタにセットします。

### .

現在のレジスタの値を出力ストリームに出力します。

### \[

#### 現在のレジスタの値が0以下のとき

*count-1*個外側の対応する`]`にジャンプします。

対応する`]`は以下のように探索されます。

1. 対応する`]`へジャンプする（これで1回とカウントする）
2. 以下を残り回数の分繰り返す：
    1. 次の`[`または`]`を検索する
        - `[`のとき、以下を`]`が見つかるまで繰り返す：
            1. 対応する`]`にジャンプする
            2. 次の`[`または`]`を検索する

```txt
まず対応する"]"へジャンプする
           +-+
           | v
|[ |[ |[ 3_[ ] [[][]] ] ] ]
             1

次の"["または"]"を検索したところ、"["だったため対応する"]"へジャンプする
             +-+
             | v
|[ |[ |[ 3_[ ] [[][]] ] ] ]
             1 |    ^
               +----+

次の"["または"]"を検索したところ、"]"だったため1回とカウントする
                    +-+
                    | v
|[ |[ |[ 3_[ ] [[][]] ] ] ]
             1        2

同様に次の"["または"]"を検索したところ、"]"だったため1回とカウントする
                      +-+
                      | v
|[ |[ |[ 3_[ ] [[][]] ] ] ]
             1        2 3
```

#### 現在のレジスタの値が0より大きいとき

1. 以下を*count*回繰り返す：
   1. リターンフィールドポインタをインクリメントする
   2. 現在のカーソルレジスタの値を、リターンフィールドにセットする

これはリターンフィールドをスタックとして、*count*回現在の実行位置をプッシュすることに相当します。

### \]

(TODO)

```txt
    +-----------------+
    v                 |
|[ |[ |[ _[[][]] |[ 3|] ] ] ]
    3  2          1
```
